<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>بيان نقدية جاهز</title>
    <!-- تحميل Tailwind CSS CDN للأنماط -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- تحميل React و ReactDOM و Babel للتعامل مع JSX -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- تحميل أيقونات Font Awesome -->
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>

    <style>
        /* خط إنتر (Inter) للأناقة */
        body {
            font-family: 'Inter', sans-serif;
        }

        /* أنماط طباعة مخصصة لإيصالات الكاشير (Receipt Printer) */
        @media print {
            /* إخفاء واجهة التطبيق والأزرار عند الطباعة */
            .hide-on-print, .App-Container > :not(.print-container) {
                display: none !important;
            }
            
            /* إزالة الهوامش من الصفحة للطباعة على بكرات الكاشير */
            @page {
                margin: 0; 
            }

            /* تهيئة منطقة الطباعة بعرض إيصال قياسي (80mm) */
            .print-container {
                display: block !important;
                position: absolute;
                top: 0;
                left: 0;
                width: 80mm; 
                max-width: 80mm;
                margin: 0;
                padding: 0;
                box-shadow: none;
                background: white;
                font-family: monospace; /* استخدام خط ثابت (Monospace) لمظهر إيصال كلاسيكي */
                color: #000;
            }

            .print-area {
                padding: 10px; 
                border: none !important; 
                box-shadow: none !important;
            }
            
            /* ضمان أن يكون كل النص أسود ومقروء بوضوح في الطباعة الحرارية */
            .print-area * {
                color: #000 !important;
                font-weight: 500 !important; 
            }

            /* تبسيط صندوق الإجمالي الكلي */
            .print-total-box { 
                background-color: transparent !important;
                border-top: 1px dashed #333 !important;
                border-bottom: 1px dashed #333 !important;
                padding: 5px 0 !important;
                margin-top: 10px !important;
            }

            .print-item span:first-child, .print-item span:last-child {
                font-weight: 900 !important; 
            }
            
            body {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
        }
    </style>
</head>
<body class="bg-gray-100">
    <div id="root"></div>

    <!-- Firebase SDKs for Firestore and Auth -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, onSnapshot, addDoc, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // جعل وظائف Firebase متاحة عالمياً داخل الـ script type="text/babel"
        window.firebaseImports = {
            initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged,
            getFirestore, collection, query, onSnapshot, addDoc, serverTimestamp, setLogLevel
        };
    </script>
    
    <!-- React Application Logic (using Babel for JSX) -->
    <script type="text/babel">
        // استيراد وظائف Firebase من النطاق العالمي (Global Scope)
        const { 
            initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged,
            getFirestore, collection, query, onSnapshot, addDoc, serverTimestamp, setLogLevel
        } = window.firebaseImports;

        const { useState, useEffect, useMemo, useCallback, memo } = React;

        // --- Firebase Configuration and Initialization ---
        let db = null;
        let auth = null;
        let appId = 'default-app-id';
        let firebaseConfig = {};

        try {
            // يتم استخدام هذه المتغيرات في بيئة القماش (Canvas) للتوثيق والإعداد
            appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
            if (Object.keys(firebaseConfig).length > 0) {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                if (db) setLogLevel('debug'); 
            }
        } catch (e) {
            console.error("فشل في تهيئة Firebase:", e);
        }

        // فئات النقدية بالجنية المصري (EGP)
        const DENOMINATIONS = [200, 100, 50, 20, 10, 5, 1];

        // دالة مساعدة لإعادة محاولة الاتصال مع تأخير أُسي
        const withRetry = async (fn, retries = 3, delay = 1000) => {
            for (let i = 0; i < retries; i++) {
                try {
                    return await fn();
                } catch (error) {
                    if (i === retries - 1) throw error;
                    console.warn(`Retry attempt ${i + 1}/${retries}. Retrying in ${delay}ms...`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2; // تأخير أُسي
                }
            }
        };

        // --- مكون إدخال الفئة النقدية ---
        const DenominationInput = memo(({ denominationValue, count, total, handleCountChange }) => {
            
            const displayValue = count === 0 ? '' : String(count);

            return (
                <div className="flex items-center bg-gray-50 p-3 rounded-lg border">
                    <span className="text-lg font-bold w-1/4 text-blue-800 text-right">{denominationValue} ج.م</span>
                    <div className="w-1/2 px-2">
                        <input
                            type="text"
                            inputMode="numeric"
                            value={displayValue}
                            onChange={(e) => handleCountChange(denominationValue, e.target.value)}
                            placeholder="العدد"
                            className="w-full text-center p-2 border border-gray-300 rounded-lg focus:border-blue-500 focus:ring-blue-500 transition-shadow"
                        />
                    </div>
                    <div className="w-1/4 text-left text-lg font-semibold text-green-700">
                        {total.toLocaleString('ar-EG')}
                    </div>
                </div>
            );
        });
        DenominationInput.displayName = 'DenominationInput';

        // --- مكون إدخال اسم المندوب ---
        const AgentNameInput = memo(({ agentName, setAgentName }) => {
            return (
                <label className="block mt-4">
                    <span className="text-sm font-medium text-gray-700">اسم المندوب (مطلوب)</span>
                    <input
                        type="text"
                        value={agentName}
                        onChange={(e) => setAgentName(e.target.value)}
                        placeholder="أدخل الاسم هنا"
                        className="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 text-lg text-center border focus:border-blue-500 focus:ring-blue-500 transition-colors"
                        required
                    />
                </label>
            );
        });
        AgentNameInput.displayName = 'AgentNameInput';


        // --- مكون علامة تبويب العد ---
        const MemoizedCountTab = memo(({
            agentName, 
            setAgentName,
            totalDenominations, 
            grandTotal, 
            handleCountChange, 
            handleSaveAndPrint, 
            resetForm, 
            message
        }) => {
            const now = new Date();
            const currentDate = now.toLocaleDateString('ar-EG');
            const currentTime = now.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' });

            const isGrandTotalZero = grandTotal === 0;
            const isAgentNameMissing = !agentName.trim();
            const isDisabled = isGrandTotalZero || isAgentNameMissing;

            let buttonText;
            let buttonIcon;
            if (isDisabled) {
                buttonIcon = "lock";
                if (isAgentNameMissing) {
                    buttonText = "الرجاء إدخال اسم المندوب";
                } else if (isGrandTotalZero) {
                    buttonText = "الإجمالي $0$: الرجاء إدخال بيانات العد";
                }
            } else {
                buttonIcon = "print";
                buttonText = "حفظ وطباعة";
            }

            return (
                <div className="p-4 space-y-4">
                    {/* بطاقة البيانات الوصفية */}
                    <div className="bg-white p-4 rounded-xl shadow-lg border border-gray-200">
                        <div className="grid grid-cols-2 gap-3 text-sm text-gray-600">
                            <div><i className="fas fa-calendar-alt ml-1 text-blue-500"></i> <span className="font-semibold">التاريخ:</span> {currentDate}</div>
                            <div><i className="fas fa-clock ml-1 text-blue-500"></i> <span className="font-semibold">الوقت:</span> {currentTime}</div>
                        </div>
                        
                        {/* إدخال اسم المندوب */}
                        <AgentNameInput agentName={agentName} setAgentName={setAgentName} />
                    </div>

                    {/* مدخلات فئات النقدية */}
                    <div className="bg-white p-4 rounded-xl shadow-lg border border-gray-200">
                        <h2 className="text-xl font-bold mb-3 text-blue-600 border-b pb-2">فئات النقدية (ج.م)</h2>
                        <div className="space-y-3">
                            {totalDenominations.map(({ value, count, total }) => (
                                <DenominationInput 
                                    key={value}
                                    denominationValue={value}
                                    count={count}
                                    total={total}
                                    handleCountChange={handleCountChange}
                                />
                            ))}
                        </div>
                    </div>

                    {/* عرض الإجمالي الكلي */}
                    <div className="bg-green-600 text-white p-4 rounded-xl shadow-2xl flex justify-between items-center mt-5">
                        <span className="text-xl font-extrabold">الإجمالي الكلي:</span>
                        <span className="text-3xl font-extrabold">{grandTotal.toLocaleString('ar-EG')} ج.م</span>
                    </div>

                    {/* الإجراءات */}
                    {message && (
                        <div className={`p-3 text-center rounded-lg font-medium ${message.includes('نجاح') ? 'bg-green-100 text-green-700' : message.includes('فشل') || message.includes('الرجاء') || message.includes('خطأ') ? 'bg-red-100 text-red-700' : 'bg-blue-100 text-blue-700'}`}>
                            {message}
                        </div>
                    )}
                    <div className="flex gap-3 pt-2">
                        <button
                            onClick={handleSaveAndPrint}
                            disabled={isDisabled}
                            className="flex-1 p-4 bg-yellow-500 text-blue-900 rounded-xl font-bold text-xl shadow-lg transition-all hover:bg-yellow-400 disabled:opacity-50 disabled:cursor-not-allowed transform hover:scale-[1.01]"
                        >
                            <i className={`fas fa-${buttonIcon} ml-2`}></i> {buttonText}
                        </button>
                        <button
                            onClick={resetForm}
                            className="p-4 bg-gray-300 text-gray-700 rounded-xl font-bold text-lg shadow-lg transition-all hover:bg-gray-400"
                        >
                            <i className="fas fa-redo"></i>
                        </button>
                    </div>
                </div>
            );
        });
        MemoizedCountTab.displayName = 'MemoizedCountTab';

        // --- مكون عرض الطباعة ---
        const PrintView = ({ transaction, resetPrintStateAndForm }) => { 
            if (!transaction) return null;

            const denominationsList = transaction.denominations
                .filter(d => d.count > 0)
                .map(d => (
                    <div key={d.value} className="flex justify-between py-1 text-sm border-b border-dashed border-gray-400 print-item">
                        <span className="w-1/3 text-right font-bold print-text">{d.value} ج.م</span>
                        <span className="w-1/3 text-center print-text">x {d.count.toLocaleString('ar-EG')}</span>
                        <span className="w-1/3 text-left font-extrabold print-text">{d.total.toLocaleString('ar-EG')}</span>
                    </div>
                ));

            // معالج لزر الطباعة اليدوي
            const handleManualPrint = () => {
                // تفعيل مربع حوار الطباعة
                window.print(); 
                
                // مسح عرض الطباعة وإعادة تعيين النموذج بعد وقت قصير
                setTimeout(() => {
                    resetPrintStateAndForm();
                }, 500); 
            };

            return (
                <div className="print-area p-6 bg-white rounded-xl shadow-lg border-2 border-dashed border-gray-400">
                    {/* زر الطباعة اليدوي (يختفي عند الطباعة الفعلية) */}
                    <button 
                        onClick={handleManualPrint} 
                        className="hide-on-print mt-2 mb-4 w-full p-3 bg-green-500 text-white rounded-lg font-bold text-lg shadow-md transition-colors hover:bg-green-600 border border-green-700"
                    >
                        <i className="fas fa-print ml-2"></i> اضغط للطباعة يدوياً (الحل المضمون)
                    </button>
                    
                    <h2 className="text-2xl font-extrabold text-center text-blue-900 mb-2 border-b-2 border-dashed pb-1">وصل بيان نقدية</h2>
                    
                    <div className="text-sm space-y-1 mb-3">
                        <p className="flex justify-between"><span className="font-semibold">المندوب:</span> <span>{transaction.agentName}</span></p>
                        <p className="flex justify-between"><span className="font-semibold">التاريخ والوقت:</span> <span>{transaction.timestamp}</span></p>
                        <p className="flex justify-between text-xs"><span className="font-semibold">رقم العملية:</span> <span>...{transaction.id.substring(transaction.id.length - 8)}</span></p>
                    </div>

                    <div className="space-y-1 p-2 border-y border-dashed border-gray-500">
                        <h3 className="text-base font-bold text-center text-blue-700">تفاصيل فئات العد</h3>
                        {denominationsList}
                    </div>

                    <div className="bg-blue-900 text-white p-2 flex justify-between items-center mt-3 mb-2 print-total-box">
                        <span className="text-base font-extrabold">الإجمالي الكلي:</span>
                        <span className="text-xl font-extrabold">{transaction.grandTotal.toLocaleString('ar-EG')} ج.م</span>
                    </div>

                    <p className="text-center text-xs text-gray-500 mt-2 border-t border-dashed pt-1">شكراً لاستخدام تطبيق بيان نقدية.</p>
                </div>
            );
        };

        // --- مكون علامة تبويب السجل ---
        const HistoryTab = ({ history, isAuthReady, userId, handleReprint }) => (
            <div className="p-4 space-y-3">
                <h2 className="text-xl font-bold text-blue-600 border-b pb-2 mb-4">سجل العمليات المحفوظة</h2>

                {!isAuthReady ? (
                    <div className="text-center p-8 bg-blue-100 rounded-xl shadow-lg text-blue-700">
                        <i className="fas fa-spinner fa-spin text-4xl mb-3"></i>
                        <p className="font-semibold">جاري تحميل نظام التوثيق...</p>
                        <p className="text-sm">يرجى الانتظار لحين تحميل السجل.</p>
                    </div>
                ) : !userId ? (
                    <div className="text-center p-8 bg-red-100 rounded-xl shadow-lg text-red-700">
                        <i className="fas fa-ban text-4xl mb-3"></i>
                        <p className="font-semibold">خطأ في الأذونات!</p>
                        <p className="text-sm">لم يتم توثيق المستخدم بنجاح. لا يمكن الوصول للبيانات الخاصة بك.</p>
                    </div>
                ) : history.length === 0 ? (
                    <div className="text-center p-8 bg-white rounded-xl shadow-lg text-gray-500">
                        <i className="fas fa-list-alt text-4xl mb-3 text-gray-400"></i>
                        <p className="font-semibold">لا يوجد عمليات سابقة محفوظة بعد.</p>
                        <p className="text-sm">قم بالتبديل إلى "عملية عد جديدة" لحفظ أول بيان.</p>
                    </div>
                ) : (
                    history.map((item, index) => (
                        <div key={item.id} className="bg-white p-4 rounded-xl shadow-lg border border-l-8 border-blue-500 transition-shadow hover:shadow-xl">
                            <div className="flex justify-between items-start mb-2">
                                <div className="text-lg font-extrabold text-blue-900">
                                    {item.grandTotal.toLocaleString('ar-EG')} ج.م
                                </div>
                                <div className="text-xs text-gray-500 text-left">
                                    <i className="fas fa-user-tag ml-1"></i> {item.agentName}
                                </div>
                            </div>

                            <div className="text-sm text-gray-600 border-t pt-2 mt-2">
                                <div className="flex justify-between">
                                    <span><i className="fas fa-clock ml-1"></i> التاريخ والوقت:</span>
                                    <span>{item.timestamp}</span>
                                </div>
                                <div className="flex justify-between">
                                    <span><i className="fas fa-id-badge ml-1"></i> رقم العملية:</span>
                                    <span>...{item.id.substring(item.id.length - 8)}</span>
                                </div>
                            </div>

                            <details className="mt-3">
                                <summary className="text-blue-500 font-medium cursor-pointer text-sm">تفاصيل الفئات</summary>
                                <ul className="mt-2 text-sm bg-gray-50 p-3 rounded-lg border">
                                    {item.denominations.map((d, i) => (
                                        <li key={i} className="flex justify-between border-b last:border-b-0 py-1">
                                            <span className="font-semibold text-gray-700">{d.value} ج.م</span>
                                            <span className="text-gray-600">العدد: {d.count.toLocaleString('ar-EG')}</span>
                                            <span className="font-bold text-green-700">الإجمالي: {d.total.toLocaleString('ar-EG')}</span>
                                        </li>
                                    ))}
                                </ul>
                            </details>
                            
                            {/* زر الطباعة للسجل */}
                            <div className="flex justify-end mt-3 border-t pt-3">
                                <button
                                    onClick={() => handleReprint(item)}
                                    className="px-4 py-2 bg-blue-500 text-white rounded-lg font-bold text-sm shadow-md transition-colors hover:bg-blue-600"
                                >
                                    <i className="fas fa-print ml-2"></i> طباعة الوصل
                                </button>
                            </div>
                        </div>
                    ))
                )}
            </div>
        );


        // --- مكون التطبيق الرئيسي ---
        const App = () => {
            const [agentName, setAgentName] = useState('');
            const [counts, setCounts] = useState(() =>
                DENOMINATIONS.reduce((acc, val) => ({ ...acc, [val]: 0 }), {})
            );
            const [history, setHistory] = useState([]);
            const [activeTab, setActiveTab] = useState('count'); // 'count' or 'history'
            const [isAuthReady, setIsAuthReady] = useState(false);
            const [userId, setUserId] = useState(null);
            const [message, setMessage] = useState('');
            const [transactionToPrint, setTransactionToPrint] = useState(null); 

            // --- 1. التوثيق والتهيئة ---
            useEffect(() => {
                if (!auth) {
                    console.error("Firebase Auth not initialized.");
                    setIsAuthReady(true); 
                    setUserId(null); 
                    return;
                }

                const handleSignIn = async () => {
                    try {
                        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                        if (initialAuthToken) {
                            await withRetry(() => signInWithCustomToken(auth, initialAuthToken));
                        } else {
                            await withRetry(() => signInAnonymously(auth));
                        }
                    } catch (error) {
                        console.error("Authentication failed during sign-in attempt:", error);
                    }
                };

                const unsubscribe = onAuthStateChanged(auth, (user) => {
                    if (user) {
                        setUserId(user.uid);
                    } else {
                        setUserId(null); 
                        console.warn("Authentication failed or user signed out.");
                    }
                    setIsAuthReady(true); 
                });

                handleSignIn();
                return () => unsubscribe();
            }, []);

            // --- 2. الاستماع للسجل في الوقت الحقيقي (Firestore) ---
            useEffect(() => {
                if (!isAuthReady || !db || !userId) return;

                const historyCollectionRef = collection(db, 'artifacts', appId, 'users', userId, 'cash_counts');
                const q = query(historyCollectionRef);

                const unsubscribe = onSnapshot(q, (snapshot) => {
                    let fetchedHistory = snapshot.docs.map(doc => {
                        const data = doc.data();
                        return {
                            id: doc.id,
                            ...data,
                            rawTimestamp: data.timestamp, 
                            timestamp: data.timestamp?.toDate().toLocaleString('ar-EG', { timeZone: 'Africa/Cairo' }) || 'N/A'
                        };
                    });
                    
                    // الترتيب حسب التاريخ (الأحدث أولاً)
                    fetchedHistory.sort((a, b) => {
                        const timeA = a.rawTimestamp?.toMillis() || 0;
                        const timeB = b.rawTimestamp?.toMillis() || 0;
                        return timeB - timeA; 
                    });

                    setHistory(fetchedHistory);
                }, (error) => {
                    console.error("Error listening to history:", error);
                    setMessage(`خطأ في تحميل السجل: ${error.message}. تأكد من صلاحيات الوصول.`);
                });

                return () => unsubscribe();
            }, [isAuthReady, userId]); 

            // --- 3. الحسابات (Memoized) ---
            const totalDenominations = useMemo(() => {
                return DENOMINATIONS.map(value => {
                    const count = counts[value] || 0;
                    const total = value * count;
                    return { value, count, total };
                });
            }, [counts]);

            const grandTotal = useMemo(() => {
                return totalDenominations.reduce((acc, item) => acc + item.total, 0);
            }, [totalDenominations]);

            // --- 4. المعالجات (Handers) ---
            
            // معالج لتغيير عدد الفئات
            const handleCountChange = useCallback((value, inputString) => {
                if (inputString === '') {
                    setCounts(prev => (prev[value] !== 0 ? { ...prev, [value]: 0 } : prev));
                    return;
                }

                if (!/^\d+$/.test(inputString)) {
                    return;
                }

                const parsedCount = parseInt(inputString);

                setCounts(prev => (prev[value] !== parsedCount ? { ...prev, [value]: parsedCount } : prev));
            }, []);

            // معالج لإعادة تعيين النموذج
            const resetForm = useCallback(() => {
                setAgentName('');
                setCounts(DENOMINATIONS.reduce((acc, val) => ({ ...acc, [val]: 0 }), {}));
                setMessage('تم إعادة تعيين بيانات العد.');
            }, []); 

            // معالج لمسح حالة الطباعة وإعادة تعيين النموذج بعد الطباعة
            const resetPrintStateAndForm = useCallback(() => {
                setTransactionToPrint(null);
                setAgentName('');
                setCounts(DENOMINATIONS.reduce((acc, val) => ({ ...acc, [val]: 0 }), {}));
                setMessage('تم الانتهاء من الطباعة. تم إعادة تعيين بيانات العد.');
            }, []);


            // معالج للحفظ والطباعة (عملية عد جديدة)
            const handleSaveAndPrint = useCallback(async () => {
                if (!db || !userId) {
                    setMessage('!خطأ في التهيئة أو التوثيق. لا يمكن حفظ البيانات.');
                    return;
                }

                if (!agentName.trim()) {
                    setMessage('!الرجاء إدخال اسم المندوب أولاً');
                    return;
                }
                if (grandTotal === 0) {
                    setMessage('!الإجمالي الكلي صفر. الرجاء إدخال فئات نقدية');
                    return;
                }

                const transactionData = {
                    agentName: agentName.trim(),
                    grandTotal,
                    userId: userId,
                    denominations: totalDenominations.filter(d => d.count > 0).map(d => ({
                        value: d.value,
                        count: d.count,
                        total: d.total
                    })),
                    timestamp: serverTimestamp(),
                };

                try {
                    setMessage('جاري حفظ العملية...');
                    const docRef = await withRetry(() => addDoc(collection(db, 'artifacts', appId, 'users', userId, 'cash_counts'), transactionData));
                    
                    const savedTransaction = {
                        id: docRef.id,
                        ...transactionData,
                        timestamp: new Date().toLocaleString('ar-EG', { timeZone: 'Africa/Cairo' }),
                        userId: userId,
                    };

                    // تعيين البيانات لعرض نموذج الطباعة
                    setTransactionToPrint(savedTransaction);
                    setMessage('تم الحفظ بنجاح! يرجى الآن **الضغط على زر الطباعة الأخضر** الذي ظهر في الوصل.');

                } catch (error) {
                    console.error("Error saving document:", error);
                    setMessage(`!فشل الحفظ: ${error.message}`);
                }
            }, [userId, agentName, grandTotal, totalDenominations]); 

            // معالج لإعادة طباعة عملية من السجل
            const handleReprintTransaction = useCallback((transaction) => {
                const printTransaction = {
                    ...transaction,
                    timestamp: transaction.timestamp || 'N/A' 
                };
                
                // تعيين البيانات لعرض نموذج الطباعة
                setTransactionToPrint(printTransaction);
                setMessage('جاري إعداد وصل الطباعة للسجل. يرجى **الضغط على زر الطباعة الأخضر**.');
            }, []);

            // --- المكونات المساعدة ---

            const Header = () => (
                <div className="p-4 bg-blue-700 text-white shadow-lg">
                    <h1 className="text-2xl font-bold text-center">بيان نقديه</h1>
                    <p className="text-xs text-center mt-1 opacity-80">أداة عد النقدية للمناديب</p>
                </div>
            );

            const TabButton = ({ tab, label, icon }) => (
                <button
                    onClick={() => setActiveTab(tab)}
                    className={`flex-1 py-3 text-center transition-colors duration-200 ${
                        activeTab === tab
                            ? 'bg-blue-600 text-white font-semibold border-b-4 border-yellow-300'
                            : 'bg-blue-800 text-blue-200 hover:bg-blue-700'
                    }`}
                >
                    <i className={`fas fa-${icon} ml-2`}></i> {label}
                </button>
            );
            
            return (
                <div className="min-h-screen bg-gray-100 flex flex-col items-center">
                    <div className="App-Container w-full max-w-md bg-white shadow-2xl rounded-xl overflow-hidden relative min-h-screen">
                        
                        {/* عرض الطباعة المشروط (يظهر فوق كل شيء) */}
                        {transactionToPrint && (
                            <div className="print-container absolute z-50 w-full h-full bg-white">
                                <PrintView 
                                    transaction={transactionToPrint} 
                                    resetPrintStateAndForm={resetPrintStateAndForm}
                                />
                            </div>
                        )}

                        {/* المحتوى الرئيسي (يختفي عند الطباعة) */}
                        <div className={`${transactionToPrint ? 'hidden' : 'block'}`}>
                            <Header />

                            {/* شريط التنقل (Tabs) */}
                            <div className="flex justify-around border-t border-b border-blue-900 bg-blue-800 sticky top-0 z-10 hide-on-print">
                                <TabButton tab="count" label="عملية عد جديدة" icon="calculator" />
                                <TabButton tab="history" label="سجل العمليات" icon="history" />
                            </div>

                            {/* منطقة المحتوى */}
                            <div className="pb-20"> 
                                {activeTab === 'count' ? (
                                    <MemoizedCountTab 
                                        agentName={agentName}
                                        setAgentName={setAgentName}
                                        totalDenominations={totalDenominations}
                                        grandTotal={grandTotal}
                                        handleCountChange={handleCountChange}
                                        handleSaveAndPrint={handleSaveAndPrint}
                                        resetForm={resetForm}
                                        message={message}
                                    />
                                ) : (
                                    <HistoryTab 
                                        history={history}
                                        isAuthReady={isAuthReady}
                                        userId={userId}
                                        handleReprint={handleReprintTransaction}
                                    />
                                )}
                            </div>

                            <div className="p-2 text-center text-xs text-gray-400 sticky bottom-0 bg-white border-t hide-on-print">
                                تم استخدام Firebase Firestore لحفظ البيانات.
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // عرض التطبيق
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
